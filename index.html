<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Therapeutic Assistant</title>
    <style>
        /* --- Base & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #1a202c;
        }

        /* --- Disclaimer Modal --- */
        #disclaimer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
            backdrop-filter: blur(5px);
            opacity: 1;
            /* Delay visibility toggle so opacity can animate first */
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }

        .modal-hidden {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }

        #disclaimer-content {
            background: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            max-width: 550px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        #disclaimer-modal.modal-visible #disclaimer-content {
            transform: scale(1);
        }

        #disclaimer-content h2 {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
        }

        #disclaimer-content p {
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            color: #4a5568;
        }
        
        #disclaimer-content strong {
            color: #c53030; /* Red-700 */
        }

        #accept-disclaimer {
            display: block;
            width: 100%;
            padding: 0.85rem;
            font-size: 1rem;
            font-weight: 500;
            color: #ffffff;
            background-color: #3182ce; /* Blue-600 */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #accept-disclaimer:hover {
            background-color: #2b6cb0; /* Blue-700 */
        }

        /* --- Chat Layout --- */
        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 768px;
            margin: 0 auto;
            background: #ffffff;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
            border-left: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
        }

        header {
            padding: 1rem 1.5rem;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
        }
        
        .logo {
            width: 32px;
            height: 32px;
            margin-right: 0.75rem;
            /* Placeholder logo - simple circle */
            background: linear-gradient(135deg, #63b3ed, #3182ce);
            border-radius: 50%;
        }

        header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
        }

        /* --- Chat Log --- */
        #chat-log {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }

        .message-content {
            padding: 0.85rem 1.25rem;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* User Message */
        .user-message {
            align-self: flex-end;
        }

        .user-message .message-content {
            background: #3182ce;
            color: #ffffff;
            border-bottom-right-radius: 4px;
        }

        /* Bot Message */
        .bot-message {
            align-self: flex-start;
        }

        .bot-message .message-content {
            background: #edf2f7;
            color: #2d3748;
            border-bottom-left-radius: 4px;
        }
        
        .bot-message .message-content p {
            margin-bottom: 0.75rem;
        }
        
        .bot-message .message-content p:last-child {
            margin-bottom: 0;
        }
        
        /* Bot message structured content */
        .bot-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #cbd5e0;
        }
        
        .bot-section h4 {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #718096;
            margin-bottom: 0.75rem;
        }
        
        .action-item, .evidence-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }
        
        .action-item::before, .evidence-item::before {
            content: 'â€¢';
            color: #3182ce;
            font-weight: bold;
            padding-top: 2px;
        }
        
        .evidence-item a {
            color: #3182ce;
            text-decoration: none;
            font-weight: 500;
        }
        .evidence-item a:hover {
            text-decoration: underline;
        }
        
        .bot-message.intent-escalate .message-content {
            background: #fff5f5;
            border: 1px solid #e53e3e;
            color: #c53030;
        }
        
        .bot-message.intent-escalate .action-item::before {
            color: #e53e3e;
        }

        /* --- Loading Spinner --- */
        .spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.85rem 1.25rem;
            align-self: flex-start;
        }
        
        .dot-flashing {
            position: relative;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: #90cdf4;
            color: #90cdf4;
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        
        .dot-flashing::before {
            left: -12px;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: #90cdf4;
            color: #90cdf4;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }
        
        .dot-flashing::after {
            left: 12px;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: #90cdf4;
            color: #90cdf4;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }
        
        @keyframes dotFlashing {
            0% { background-color: #90cdf4; }
            50%, 100% { background-color: #e2e8f0; }
        }

        /* --- Chat Input Form --- */
        #chat-form {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background: #fdfdfd;
        }

        #user-input {
            flex-grow: 1;
            border: 1px solid #cbd5e0;
            border-radius: 20px;
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
            line-height: 1.5;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #user-input:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
        }

        #chat-form button {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #3182ce;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            min-width: 44px;
            margin-left: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #chat-form button:hover {
            background-color: #2b6cb0;
        }
        
        #chat-form button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }

        #chat-form button svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>

    <!-- --- Disclaimer Modal --- -->
    <div id="disclaimer-modal">
        <div id="disclaimer-content">
            <h2>Therapeutic Assistant</h2>
            <p>
                This is for demonstration purposes only. It is <strong>not a medical device or a diagnostic tool</strong>.
            </p>
            <p>
                The guidance provided is generated by AI and is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition.
            </p>
            <p>
                <strong>If you are experiencing a medical emergency, please contact your local emergency services immediately.</strong>
            </p>
                <button id="accept-disclaimer" type="button">I Understand and Accept</button>
            </div>
        </div>

    <!-- --- Chat Container --- -->
    <div id="chat-container">
        <!-- Header -->
        <header>
            <div class="logo"></div>
            <h1>Therapeutic Assistant</h1>
        </header>

        <!-- Chat Log -->
        <div id="chat-log">
            <!-- Messages will be injected here -->
            <div class="message bot-message">
                <div class="message-content">
                    <p>Hello! I am your Health Assistant. How are you feeling today?</p>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <form id="chat-form">
            <input type="text" id="user-input" placeholder="Tell me what you're feeling..." autocomplete="off">
            <button type="submit" id="send-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                    <path d="M3.105 3.106c.806-.806 2.095-.806 2.9 0L6 3.099l.904-.904a2.05 2.05 0 0 1 2.9 0l.904.904.904-.904a2.05 2.05 0 0 1 2.9 0l.904.904.904-.904a2.05 2.05 0 0 1 2.9 0l.904.904 1.096-1.096a.75.75 0 0 1 1.06 1.06l-1.096 1.096.904.904a2.05 2.05 0 0 1 0 2.9l-.904.904.904.904a2.05 2.05 0 0 1 0 2.9l-.904.904.904.904a2.05 2.05 0 0 1 0 2.9l-.904.904.904.904a2.05 2.05 0 0 1 0 2.9l-.904.904-1.096 1.096a.75.75 0 0 1-1.06-1.06l1.096-1.096-.904-.904a2.05 2.05 0 0 1-2.9 0l-.904-.904-.904.904a2.05 2.05 0 0 1-2.9 0l-.904-.904-.904.904a2.05 2.05 0 0 1-2.9 0l-.904-.904-.904.904a2.05 2.05 0 0 1-2.9 0l-.904-.904L3.105 3.106Z" />
                </svg>
                <!-- Send Icon SVG -->
                <svg style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L6 12Z" />
                </svg>
            </button>
        </form>
    </div>

    <script>
        // --- DOM Elements ---
        const disclaimerModal = document.getElementById('disclaimer-modal');
        const acceptButton = document.getElementById('accept-disclaimer');
        const chatLog = document.getElementById('chat-log');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        // --- State ---
        let chatHistory = [];
        let isLoading = false;
        
        // --- Initial Bot Message (not in history) ---
        const initialBotMessage = {
            role: "assistant",
            content: JSON.stringify({
                summary: "Hello! I'm your Health Assistant. How are you feeling today?",
                intent: "self-care",
                actions: [],
                evidence: [],
                confidence: 1.0
            })
        };
        // We add the *next* message to history, so the initial greeting is just for show.
        // A better way would be to add it to history, but this is simpler for the POC.

        // --- Disclaimer Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // Respect prior acceptance across reloads
            const accepted = localStorage.getItem('disclaimerAccepted') === 'true';
            if (!accepted) {
                // Show modal on first visit
                disclaimerModal.classList.add('modal-visible');
                disclaimerModal.classList.remove('modal-hidden');
            } else {
                // Keep it hidden on subsequent visits
                disclaimerModal.classList.add('modal-hidden');
                disclaimerModal.classList.remove('modal-visible');
            }
        });

        acceptButton.onclick = () => {
            // Persist acceptance
            localStorage.setItem('disclaimerAccepted', 'true');

            // Hide modal with fade-out, then remove from layout
            disclaimerModal.classList.add('modal-hidden');
            disclaimerModal.classList.remove('modal-visible');
            disclaimerModal.addEventListener('transitionend', () => {
                disclaimerModal.style.display = 'none';
            }, { once: true });

            // Bring user to the main chat area
            document.getElementById('chat-container').scrollIntoView({ behavior: 'smooth' });
            userInput.focus();
        };

        // --- Chat Form Submission ---
        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message || isLoading) return;

            // Add user message to UI
            addMessageToLog('user', message);
            userInput.value = '';
            
            // Show loading spinner
            showSpinner();
            setLoading(true);

            try {
                // Send to backend
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: chatHistory,
                    }),
                });

                // Get response data
                const data = await response.json();
                
                removeSpinner();

                if (!response.ok) {
                    // Handle HTTP errors (like 500, 404)
                    throw new Error(data.detail || 'An unknown error occurred.');
                }

                // Add bot message to UI
                addBotMessageToLog(data);

                // Update chat history
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: JSON.stringify(data) });

            } catch (error) {
                console.error('Chat error:', error);
                removeSpinner();
                // Show an error message in the chat
                addBotMessageToLog({
                    intent: "escalate", // Use "escalate" style for errors
                    summary: "I'm sorry, but I encountered an error.",
                    actions: [{ type: "information", text: error.message }],
                    confidence: 1.0,
                    evidence: []
                });
            } finally {
                setLoading(false);
            }
        };

        // --- UI Helper Functions ---

        function setLoading(loading) {
            isLoading = loading;
            sendButton.disabled = loading;
            userInput.disabled = loading;
        }

        function addMessageToLog(sender, message) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message ${sender}-message`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = message;
            
            messageWrapper.appendChild(messageContent);
            chatLog.appendChild(messageWrapper);
            scrollToBottom();
        }

        function addBotMessageToLog(data) {
            // 'data' is the parsed JSON object from the server
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message bot-message intent-${data.intent}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Summary
            const summary = document.createElement('p');
            summary.textContent = data.summary;
            messageContent.appendChild(summary);

            // Actions
            if (data.actions && data.actions.length > 0) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'bot-section';
                
                const actionsTitle = document.createElement('h4');
                actionsTitle.textContent = 'Suggestions';
                actionsDiv.appendChild(actionsTitle);
                
                data.actions.forEach(action => {
                    const item = document.createElement('div');
                    item.className = 'action-item';
                    item.textContent = action.text;
                    actionsDiv.appendChild(item);
                });
                messageContent.appendChild(actionsDiv);
            }

            // Evidence
            if (data.evidence && data.evidence.length > 0) {
                const evidenceDiv = document.createElement('div');
                evidenceDiv.className = 'bot-section';
                
                const evidenceTitle = document.createElement('h4');
                evidenceTitle.textContent = 'Learn More';
                evidenceDiv.appendChild(evidenceTitle);
                
                data.evidence.forEach(evi => {
                    const item = document.createElement('div');
                    item.className = 'evidence-item';
                    
                    const link = document.createElement('a');
                    link.href = evi.link;
                    link.textContent = evi.title;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    
                    const source = document.createElement('span');
                    source.textContent = ` (${evi.source})`;
                    
                    item.appendChild(link);
                    item.appendChild(source);
                    evidenceDiv.appendChild(item);
                });
                messageContent.appendChild(evidenceDiv);
            }
            
            messageWrapper.appendChild(messageContent);
            chatLog.appendChild(messageWrapper);
            scrollToBottom();
        }

        function showSpinner() {
            const spinner = document.createElement('div');
            spinner.className = 'message bot-message spinner';
            spinner.id = 'loading-spinner';
            spinner.innerHTML = '<div class="dot-flashing"></div>';
            chatLog.appendChild(spinner);
            scrollToBottom();
        }

        function removeSpinner() {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) {
                spinner.remove();
            }
        }

        function scrollToBottom() {
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Simple SVG icon replacement for send button
        // Replace the placeholder 'X' icon with the send icon
        sendButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L6 12Z" />
            </svg>`;

    </script>
</body>
</html>
